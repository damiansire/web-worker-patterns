<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>09 - Angular - Descarga de C√≥mputo Pesado</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>‚ö° Angular + Web Workers - Descarga de C√≥mputo</h1>
        <p class="subtitle">Ejemplo 02: Evitando el bloqueo de la UI con Angular</p>

        <div class="info-box">
            <strong>üí° ¬øQu√© demuestra este ejemplo?</strong>
            Calcula n√∫meros primos de forma intensiva usando un Worker con Angular. 
            Compara el enfoque con Worker vs sin Worker, mostrando c√≥mo mantener la UI fluida.
        </div>

        <details class="code-explanation">
            <summary>üìñ Ver C√≥digo - ¬øC√≥mo funciona?</summary>
            
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-button active" data-tab="service">üì¶ computation.service.ts</button>
                    <button class="tab-button" data-tab="component">‚öôÔ∏è app.component.ts</button>
                    <button class="tab-button" data-tab="template">üé® app.component.html</button>
                    <button class="tab-button" data-tab="worker">üîß worker.js</button>
                </div>

                <div id="service" class="tab-content active">
                    <div class="code-section">
                        <h3>Servicio de C√≥mputo</h3>
                        <pre><code><span class="keyword">import</span> { <span class="variable">injectable</span> } <span class="keyword">from</span> <span class="string">'@angular/core'</span>;
<span class="keyword">import</span> { <span class="variable">Subject</span> } <span class="keyword">from</span> <span class="string">'rxjs'</span>;

<span class="variable">@Injectable</span>({ <span class="property">providedIn</span>: <span class="string">'root'</span> })
<span class="keyword">export class</span> <span class="function">ComputationService</span> {
    <span class="keyword">private</span> <span class="variable">worker</span>: <span class="function">Worker</span>;
    <span class="keyword">private</span> <span class="variable">resultSubject</span> = <span class="keyword">new</span> <span class="function">Subject</span>&lt;<span class="variable">any</span>&gt;();
    
    <span class="function">constructor</span>() {
        <span class="keyword">if</span> (<span class="variable">typeof Worker</span> !== <span class="string">'undefined'</span>) {
            <span class="keyword">this</span>.<span class="variable">worker</span> = <span class="keyword">new</span> <span class="function">Worker</span>(<span class="string">'./worker.js'</span>);
            <span class="keyword">this</span>.<span class="variable">setupWorker</span>();
        }
    }
    
    <span class="function">calculatePrimes</span>(<span class="variable">count</span>: <span class="variable">number</span>) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.<span class="variable">worker</span>) {
            <span class="keyword">this</span>.<span class="variable">worker</span>.<span class="function">postMessage</span>({ <span class="property">count</span> });
        }
        <span class="keyword">return</span> <span class="keyword">this</span>.<span class="variable">resultSubject</span>.<span class="function">asObservable</span>();
    }
    
    <span class="keyword">private</span> <span class="function">setupWorker</span>(): <span class="keyword">void</span> {
        <span class="keyword">this</span>.<span class="variable">worker</span>.<span class="property">onmessage</span> = (<span class="variable">e</span>) =&gt; {
            <span class="keyword">this</span>.<span class="variable">resultSubject</span>.<span class="function">next</span>(<span class="variable">e</span>.<span class="property">data</span>);
        };
        
        <span class="keyword">this</span>.<span class="variable">worker</span>.<span class="property">onerror</span> = (<span class="variable">error</span>) =&gt; {
            <span class="keyword">this</span>.<span class="variable">resultSubject</span>.<span class="function">error</span>(<span class="variable">error</span>);
        };
    }
    
    <span class="function">ngOnDestroy</span>(): <span class="keyword">void</span> {
        <span class="keyword">if</span> (<span class="keyword">this</span>.<span class="variable">worker</span>) {
            <span class="keyword">this</span>.<span class="variable">worker</span>.<span class="function">terminate</span>();
        }
    }
}</code></pre>
                    </div>
                </div>

                <div id="component" class="tab-content">
                    <div class="code-section">
                        <h3>Componente con Estado Reactivo</h3>
                        <pre><code><span class="keyword">import</span> { <span class="variable">Component</span>, <span class="variable">signal</span>, <span class="variable">inject</span>, <span class="variable">effect</span> } <span class="keyword">from</span> <span class="string">'@angular/core'</span>;
<span class="keyword">import</span> { <span class="variable">ComputationService</span> } <span class="keyword">from</span> <span class="string">'./computation.service'</span>;

<span class="variable">@Component</span>({
    <span class="property">selector</span>: <span class="string">'app-root'</span>,
    <span class="property">templateUrl</span>: <span class="string">'./app.component.html'</span>,
    <span class="property">standalone</span>: <span class="keyword">true</span>
})
<span class="keyword">export class</span> <span class="function">AppComponent</span> {
    <span class="comment">// Angular 21: inject() function</span>
    <span class="keyword">private</span> <span class="variable">computationService</span> = <span class="function">inject</span>(<span class="variable">ComputationService</span>);
    
    <span class="comment">// Angular 21: Signals for reactive state</span>
    <span class="variable">count</span> = <span class="function">signal</span>(<span class="number">50000</span>);
    <span class="variable">result</span> = <span class="function">signal</span>&lt;<span class="variable">any</span> | <span class="keyword">null</span>&gt;(<span class="keyword">null</span>);
    <span class="variable">loading</span> = <span class="function">signal</span>(<span class="keyword">false</span>);
    <span class="variable">counter</span> = <span class="function">signal</span>(<span class="number">0</span>);
    
    <span class="function">constructor</span>() {
        <span class="comment">// Angular 21: effect() for side effects</span>
        <span class="function">effect</span>(() =&gt; {
            <span class="function">setInterval</span>(() =&gt; {
                <span class="keyword">this</span>.<span class="variable">counter</span>.<span class="function">update</span>(<span class="variable">c</span> =&gt; <span class="variable">c</span> + <span class="number">1</span>);
            }, <span class="number">100</span>);
        });
    }
    
    <span class="function">calculateWithWorker</span>(): <span class="keyword">void</span> {
        <span class="keyword">this</span>.<span class="variable">loading</span>.<span class="function">set</span>(<span class="keyword">true</span>);
        <span class="keyword">const</span> <span class="variable">startTime</span> = <span class="function">performance.now</span>();
        
        <span class="keyword">this</span>.<span class="variable">computationService</span>.<span class="function">calculatePrimes</span>(<span class="keyword">this</span>.<span class="variable">count</span>())
            .<span class="function">subscribe</span>(<span class="variable">result</span> =&gt; {
                <span class="keyword">const</span> <span class="variable">duration</span> = <span class="function">performance.now</span>() - <span class="variable">startTime</span>;
                <span class="keyword">this</span>.<span class="variable">result</span>.<span class="function">set</span>({
                    <span class="property">...result</span>,
                    <span class="property">duration</span>,
                    <span class="property">method</span>: <span class="string">'Worker'</span>
                });
                <span class="keyword">this</span>.<span class="variable">loading</span>.<span class="function">set</span>(<span class="keyword">false</span>);
            });
    }
    
    <span class="function">calculateWithoutWorker</span>(): <span class="keyword">void</span> {
        <span class="keyword">this</span>.<span class="variable">loading</span>.<span class="function">set</span>(<span class="keyword">true</span>);
        <span class="keyword">const</span> <span class="variable">startTime</span> = <span class="function">performance.now</span>();
        
        <span class="keyword">const</span> <span class="variable">primes</span> = <span class="keyword">this</span>.<span class="variable">calculatePrimes</span>(<span class="keyword">this</span>.<span class="variable">count</span>());
        <span class="keyword">const</span> <span class="variable">duration</span> = <span class="function">performance.now</span>() - <span class="variable">startTime</span>;
        
        <span class="keyword">this</span>.<span class="variable">result</span>.<span class="function">set</span>({
            <span class="property">primes</span>,
            <span class="property">count</span>: <span class="variable">primes.length</span>,
            <span class="property">duration</span>,
            <span class="property">method</span>: <span class="string">'Hilo Principal'</span>
        });
        <span class="keyword">this</span>.<span class="variable">loading</span>.<span class="function">set</span>(<span class="keyword">false</span>);
    }
    
    <span class="keyword">private</span> <span class="function">calculatePrimes</span>(<span class="variable">max</span>: <span class="variable">number</span>): <span class="variable">number</span>[] {
        <span class="comment">// Implementaci√≥n bloqueante del c√°lculo</span>
        <span class="keyword">const</span> <span class="variable">primes</span>: <span class="variable">number</span>[] = [];
        <span class="keyword">for</span> (<span class="keyword">let</span> <span class="variable">i</span> = <span class="number">2</span>; <span class="variable">primes</span>.<span class="property">length</span> &lt; <span class="variable">max</span>; <span class="variable">i</span>++) {
            <span class="keyword">let</span> <span class="variable">isPrime</span> = <span class="keyword">true</span>;
            <span class="keyword">for</span> (<span class="keyword">let</span> <span class="variable">j</span> = <span class="number">2</span>; <span class="variable">j</span> &lt;= <span class="function">Math.sqrt</span>(<span class="variable">i</span>); <span class="variable">j</span>++) {
                <span class="keyword">if</span> (<span class="variable">i</span> % <span class="variable">j</span> === <span class="number">0</span>) {
                    <span class="variable">isPrime</span> = <span class="keyword">false</span>;
                    <span class="keyword">break</span>;
                }
            }
            <span class="keyword">if</span> (<span class="variable">isPrime</span>) <span class="variable">primes</span>.<span class="function">push</span>(<span class="variable">i</span>);
        }
        <span class="keyword">return</span> <span class="variable">primes</span>;
    }
}</code></pre>
                    </div>
                </div>

                <div id="template" class="tab-content">
                    <div class="code-section">
                        <h3>Template con Estado Reactivo</h3>
                        <pre><code><span class="comment">&lt;!-- Angular 21: Control flow --&gt;</span>
<span class="keyword">&lt;input</span> 
    <span class="property">type</span>=<span class="string">"number"</span>
    [(<span class="property">ngModel</span>)]=<span class="string">"count()"</span>
    <span class="property">min</span>=<span class="string">"1000"</span>
    <span class="property">max</span>=<span class="string">"100000"</span>
<span class="keyword">&gt;</span>

<span class="keyword">&lt;button</span> 
    (<span class="property">click</span>)=<span class="string">"calculateWithWorker()"</span>
    [<span class="property">disabled</span>]=<span class="string">"loading()"</span>
<span class="keyword">&gt;</span>
    üöÄ Calcular con Worker
<span class="keyword">&lt;/button&gt;</span>

<span class="keyword">&lt;button</span> 
    (<span class="property">click</span>)=<span class="string">"calculateWithoutWorker()"</span>
    [<span class="property">disabled</span>]=<span class="string">"loading()"</span>
<span class="keyword">&gt;</span>
    üêå Calcular en Hilo Principal
<span class="keyword">&lt;/button&gt;</span>

<span class="comment">&lt;!-- Angular 21: @if instead of *ngIf --&gt;</span>
@<span class="variable">if</span> (<span class="variable">loading</span>()) {
    &lt;<span class="variable">div</span>&gt;‚è≥ Calculando...&lt;/<span class="variable">div</span>&gt;
}

@<span class="variable">if</span> (<span class="variable">result</span>() && !<span class="variable">loading</span>()) {
    &lt;<span class="variable">div</span>&gt;
        &lt;<span class="variable">h3</span>&gt;{{ <span class="variable">result</span>().<span class="property">method</span> }} complet√≥ el c√°lculo&lt;/<span class="variable">h3</span>&gt;
        &lt;<span class="variable">br</span>&gt;Total: {{ <span class="variable">result</span>().<span class="property">count</span> }}
        &lt;<span class="variable">br</span>&gt;Tiempo: {{ <span class="variable">result</span>().<span class="property">duration</span> | <span class="variable">number</span> }}ms
    &lt;/<span class="variable">div</span>&gt;
}

&lt;<span class="variable">div</span>&gt;Contador: {{ <span class="variable">counter</span>() }}&lt;/<span class="variable">div</span>&gt;</code></pre>
                    </div>
                </div>

                <div id="worker" class="tab-content">
                    <div class="code-section">
                        <h3>Worker (worker.js)</h3>
                        <pre><code><span class="comment">// Funci√≥n para calcular n√∫meros primos</span>
<span class="keyword">function</span> <span class="function">calculatePrimes</span>(<span class="variable">max</span>) {
    <span class="keyword">const</span> <span class="variable">primes</span> = [];
    
    <span class="keyword">for</span> (<span class="keyword">let</span> <span class="variable">i</span> = <span class="number">2</span>; <span class="variable">primes</span>.<span class="property">length</span> &lt; <span class="variable">max</span>; <span class="variable">i</span>++) {
        <span class="keyword">let</span> <span class="variable">isPrime</span> = <span class="keyword">true</span>;
        
        <span class="keyword">for</span> (<span class="keyword">let</span> <span class="variable">j</span> = <span class="number">2</span>; <span class="variable">j</span> &lt;= <span class="function">Math.sqrt</span>(<span class="variable">i</span>); <span class="variable">j</span>++) {
            <span class="keyword">if</span> (<span class="variable">i</span> % <span class="variable">j</span> === <span class="number">0</span>) {
                <span class="variable">isPrime</span> = <span class="keyword">false</span>;
                <span class="keyword">break</span>;
            }
        }
        
        <span class="keyword">if</span> (<span class="variable">isPrime</span>) {
            <span class="variable">primes</span>.<span class="function">push</span>(<span class="variable">i</span>);
        }
    }
    
    <span class="keyword">return</span> <span class="variable">primes</span>;
}

<span class="comment">// Escuchar mensajes del componente</span>
<span class="variable">self</span>.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="variable">e</span>) {
    <span class="keyword">const</span> { <span class="variable">count</span> } = <span class="variable">e</span>.<span class="property">data</span>;
    <span class="keyword">const</span> <span class="variable">primes</span> = <span class="function">calculatePrimes</span>(<span class="variable">count</span>);
    
    <span class="variable">self</span>.<span class="function">postMessage</span>({
        <span class="property">primes</span>: <span class="variable">primes</span>,
        <span class="property">count</span>: <span class="variable">primes.length</span>
    });
};</code></pre>
                    </div>
                </div>
            </div>
        </details>

        <div class="comparison-box" style="margin: 30px 0;">
            <div class="comparison-column bad">
                <h4>‚ùå Sin Worker (Hilo Principal)</h4>
                <ul>
                    <li>UI se congela</li>
                    <li>Animaciones se detienen</li>
                    <li>Contador se pausa</li>
                </ul>
            </div>
            <div class="comparison-column good">
                <h4>‚úÖ Con Worker</h4>
                <ul>
                    <li>UI permanece fluida</li>
                    <li>Animaciones contin√∫an</li>
                    <li>Contador sigue contando</li>
                </ul>
            </div>
        </div>

        <div class="demo-section">
            <h3>üî¢ Calculadora de N√∫meros Primos</h3>
            
            <div class="input-group">
                <label for="numberInput">¬øCu√°ntos n√∫meros primos calcular?</label>
                <input 
                    type="number" 
                    id="numberInput" 
                    value="50000" 
                    min="1000" 
                    max="100000"
                    step="1000"
                >
            </div>

            <div class="button-group">
                <button class="btn-worker" id="workerBtn">
                    üöÄ Calcular con Worker<br>
                    <small style="font-size: 11px; font-weight: normal;">(No bloquea la UI)</small>
                </button>
                <button class="btn-main" id="mainBtn">
                    üêå Calcular en Hilo Principal<br>
                    <small style="font-size: 11px; font-weight: normal;">(Bloquea la UI)</small>
                </button>
            </div>

            <div class="spinner" id="spinner"></div>
            <div id="result"></div>
        </div>

        <div class="ui-test">
            <h3 style="margin-bottom: 10px;">üéØ Prueba de Respuesta de la UI</h3>
            <p style="font-size: 14px; opacity: 0.9;">Si la UI est√° bloqueada, este contador se congelar√°</p>
            <div class="counter" id="counter">0</div>
            <div class="animation-box"></div>
        </div>
    </div>

    <script>
        // Funcionalidad de tabs
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');

                    // Remover clase active de todos los botones y contenidos
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Agregar clase active al bot√≥n y contenido seleccionado
                    button.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                });
            });
        });

        // Demo simulation
        let counter = 0;
        setInterval(() => {
            counter++;
            document.getElementById('counter').textContent = counter;
        }, 100);

        const worker = new Worker('worker.js');
        
        document.getElementById('workerBtn').addEventListener('click', function() {
            const count = parseInt(document.getElementById('numberInput').value);
            document.getElementById('spinner').classList.add('active');
            
            worker.postMessage({ count });
        });
        
        worker.onmessage = function(e) {
            document.getElementById('spinner').classList.remove('active');
            document.getElementById('result').innerHTML = `<strong>‚úÖ C√°lculo completado</strong><br>Total: ${e.data.count} n√∫meros primos`;
        };
    </script>
</body>
</html>

