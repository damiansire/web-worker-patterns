<div class="example-content">
  <h1>{{ texts().title }}</h1>
  <p class="subtitle">{{ texts().subtitle }}</p>

  <app-info-box [title]="texts().infoTitle">
    {{ texts().infoDescription }}
  </app-info-box>

  <div class="comparison-box">
    <div class="comparison-column bad">
      <h4>{{ texts().comparison?.badTitle }}</h4>
      <ul>
        @for (item of texts().comparison?.badItems; track item) {
          <li>{{ item }}</li>
        }
      </ul>
    </div>
    <div class="comparison-column good">
      <h4>{{ texts().comparison?.goodTitle }}</h4>
      <ul>
        @for (item of texts().comparison?.goodItems; track item) {
          <li>{{ item }}</li>
        }
      </ul>
    </div>
  </div>

  <app-code-explanation [summaryText]="texts().codeSummary">
    <app-code-section [title]="texts().codeSections?.createPool">
      <pre ngNonBindable><code>class WorkerPool {{ '{' }}
    constructor(poolSize, workerScript) {{ '{' }}
        this.poolSize = poolSize;
        this.workers = [];
        this.taskQueue = [];
        // Crear workers fijos
        for (let i = 0; i < poolSize; i++) {{ '{' }}
            const worker = new Worker(workerScript);
            this.workers.push({{ '{' }} id: i, instance: worker, busy: false {{ '}' }});
        {{ '}' }}
    {{ '}' }}
{{ '}' }}
</code></pre>
    </app-code-section>
    <app-code-section [title]="texts().codeSections?.addTask">
      <pre ngNonBindable><code>addTask(task) {{ '{' }}
    this.taskQueue.push(task);
    this.processQueue();
{{ '}' }}
</code></pre>
    </app-code-section>
    <app-code-section [title]="texts().codeSections?.assignTask">
      <pre ngNonBindable><code>processQueue() {{ '{' }}
    const available = this.workers.filter(w => !w.busy);
    available.forEach(worker => {{ '{' }}
        if (this.taskQueue.length > 0) {{ '{' }}
            const task = this.taskQueue.shift();
            worker.busy = true;
            worker.instance.postMessage(task);
        {{ '}' }}
    {{ '}' }});
{{ '}' }}
</code></pre>
    </app-code-section>
    <app-code-section [title]="texts().codeSections?.receiveResult">
      <pre ngNonBindable><code>worker.instance.onmessage = (e) => {{ '{' }}
    worker.busy = false;
    this.processQueue();
    handleResult(e.data);
{{ '}' }};
</code></pre>
    </app-code-section>
    <app-code-section tech="angular" [title]="texts().codeSections?.createPool">
      <pre ngNonBindable><code class="language-typescript">class WorkerPool {{ '{' }}
  constructor(
    private size: number,
    private component: WorkerPoolComponent,
    private statsCallback: () => void
  ) {{ '{' }}
    this.startTime = Date.now();
    this.initializeWorkers();
  {{ '}' }}

  private initializeWorkers() {{ '{' }}
    for (let i = 0; i < this.size; i++) {{ '{' }}
      const worker: WorkerData = {{ '{' }}
        id: i + 1,
        instance: new Worker(new URL('./worker-pool.worker', import.meta.url), {{ '{' }} type: 'module' {{ '}' }}),
        busy: false,
        currentTask: null
      {{ '}' }};

      worker.instance.onmessage = (event: MessageEvent) => {{ '{' }}
        this.handleWorkerComplete(worker, event.data);
      {{ '}' }};

      this.workers.push(worker);
    {{ '}' }}
  {{ '}' }}
{{ '}' }}
</code></pre>
    </app-code-section>
    <app-code-section tech="angular" [title]="texts().codeSections?.addTask">
      <pre ngNonBindable><code class="language-typescript">addTasks(tasks: Task[]) {{ '{' }}
  this.component.addLog(
    this.component.format(this.component.texts().logs?.tasksAdded ?? '', {{ '{' }} count: tasks.length {{ '}' }}),
    'info'
  );

  this.taskQueue.push(...tasks);
  this.processQueue();
{{ '}' }}
</code></pre>
    </app-code-section>
    <app-code-section tech="angular" [title]="texts().codeSections?.assignTask">
      <pre ngNonBindable><code class="language-typescript">private processQueue() {{ '{' }}
  const available = this.workers.filter(worker => !worker.busy);

  available.forEach(worker => {{ '{' }}
    const task = this.taskQueue.shift();
    if (task) {{ '{' }}
      this.assignTaskToWorker(worker, task);
    {{ '}' }}
  {{ '}' }});

  this.statsCallback();
{{ '}' }}
</code></pre>
    </app-code-section>
    <app-code-section tech="angular" [title]="texts().codeSections?.receiveResult">
      <pre ngNonBindable><code class="language-typescript">private assignTaskToWorker(worker: WorkerData, task: Task) {{ '{' }}
  worker.busy = true;
  worker.currentTask = task;
  task.startedAt = Date.now();

  worker.instance.postMessage({{ '{' }}
    taskId: task.id,
    data: task.data,
    duration: task.duration
  {{ '}' }});
{{ '}' }}

private handleWorkerComplete(worker: WorkerData, result: any) {{ '{' }}
  worker.busy = false;
  worker.currentTask = null;
  this.processQueue();
  this.statsCallback();
{{ '}' }}
</code></pre>
    </app-code-section>
  </app-code-explanation>

  <app-stats-panel [title]="texts().statsPanel?.title" [stats]="getStats()"></app-stats-panel>

  <div class="control-panel">
    <h3>{{ texts().controls?.title }}</h3>
    
    <div class="form-row">
      <div class="form-group">
        <label>{{ texts().controls?.poolSizeLabel }}</label>
        <input type="number" [ngModel]="poolSizeInput()" (ngModelChange)="poolSizeInput.set($event)" min="1" max="16" />
        <small>{{ texts().controls?.poolSizeHint }}</small>
      </div>
      <div class="form-group">
        <button class="btn-primary" (click)="initializePool()">{{ texts().controls?.initButton }}</button>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>{{ texts().controls?.taskCountLabel }}</label>
        <input type="number" [ngModel]="taskCount()" (ngModelChange)="taskCount.set($event)" min="1" max="1000" />
        <small>{{ texts().controls?.taskHint }}</small>
      </div>
      <div class="form-group">
        <label>{{ texts().controls?.taskDurationLabel }}</label>
        <input type="number" [ngModel]="taskDuration()" (ngModelChange)="taskDuration.set($event)" min="100" max="5000" step="100" />
      </div>
    </div>

    <div class="button-grid">
      <button class="btn-success" (click)="addTasks()" [disabled]="!poolInitialized()">{{ texts().controls?.addTasks }}</button>
      <button class="btn-stress" (click)="stressTest()" [disabled]="!poolInitialized()">{{ texts().controls?.stressTest }}</button>
      <button class="btn-danger" (click)="clearQueue()" [disabled]="!poolInitialized()">{{ texts().controls?.clearQueue }}</button>
      <button class="btn-secondary" (click)="shutdownPool()" [disabled]="!poolInitialized()">{{ texts().controls?.shutdown }}</button>
    </div>
  </div>

  <app-log-panel 
    [logs]="logs()" 
    [title]="texts().logPanel?.title"
    [emptyMessage]="texts().logPanel?.empty"
    (clear)="clearLogs()">
  </app-log-panel>
</div>
