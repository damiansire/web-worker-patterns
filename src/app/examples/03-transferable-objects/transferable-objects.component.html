<div class="example-content">
  <h1>{{ texts().title }}</h1>
  <p class="subtitle">{{ texts().subtitle }}</p>

  <app-info-box [title]="texts().infoTitle">
    {{ texts().infoDescription }}
  </app-info-box>

  <app-code-explanation [summaryText]="texts().codeSummary">
    <app-code-section [title]="texts().codeSections.createBuffer">
      <pre ngNonBindable><code>const imageData = new ImageData(1024, 1024);
const buffer = imageData.data.buffer;
</code></pre>
    </app-code-section>
    <app-code-section [title]="texts().codeSections.methodClone">
      <pre ngNonBindable><code>worker.postMessage({{ '{' }} imageData: imageData {{ '}' }});
// El buffer original sigue siendo accesible
</code></pre>
    </app-code-section>
    <app-code-section [title]="texts().codeSections.methodTransfer">
      <pre ngNonBindable><code>worker.postMessage({{ '{' }} imageData: imageData {{ '}' }}, [imageData.data.buffer]);
// ⚠️ El buffer original queda INACCESIBLE
</code></pre>
    </app-code-section>
    <app-code-section tech="angular" [title]="texts().codeSections.createBuffer">
      <pre ngNonBindable><code class="language-typescript">private generateImageData(sizeMB: number) {{ '{' }}
  const width = Math.sqrt((sizeMB * 1024 * 1024) / 4);
  const pixels = Math.floor(width * width);

  const buffer = new ArrayBuffer(pixels * 4);
  const view = new Uint8Array(buffer);

  for (let i = 0; i < pixels; i++) {{ '{' }}
    const offset = i * 4;
    view[offset] = i % 256;
    view[offset + 1] = (i * 2) % 256;
    view[offset + 2] = (i * 3) % 256;
    view[offset + 3] = 255;
  {{ '}' }}

  return {{ '{' }}
    buffer,
    width: Math.floor(width),
    height: Math.floor(width)
  {{ '}' }};
{{ '}' }}
</code></pre>
    </app-code-section>
    <app-code-section tech="angular" [title]="texts().codeSections.methodClone">
      <pre ngNonBindable><code class="language-typescript">processWithClone() {{ '{' }}
  const sizeMB = this.sizeMB();
  this.isLoading.set(true);

  const imageData = this.generateImageData(sizeMB);
  this.displayImage(imageData, 'original');
  this.processingStartTime = performance.now();

  this.worker?.postMessage({{ '{' }}
    type: 'process',
    imageData,
    transferable: false
  {{ '}' }});
{{ '}' }}
</code></pre>
    </app-code-section>
    <app-code-section tech="angular" [title]="texts().codeSections.methodTransfer">
      <pre ngNonBindable><code class="language-typescript">processWithTransfer() {{ '{' }}
  const sizeMB = this.sizeMB();
  this.isLoading.set(true);

  const imageData = this.generateImageData(sizeMB);
  this.displayImage(imageData, 'original');
  this.processingStartTime = performance.now();

  this.worker?.postMessage({{ '{' }}
    type: 'process',
    imageData,
    transferable: true
  {{ '}' }}, [imageData.buffer]);
{{ '}' }}
</code></pre>
    </app-code-section>
  </app-code-explanation>

  <div class="demo-section">
    <h3>{{ texts().demo.title }}</h3>
    
    <div class="size-selector">
      <label>{{ texts().demo.sizeLabel }}</label>
      <select [ngModel]="sizeMB()" (ngModelChange)="sizeMB.set($event)">
        @for (option of sizeOptions(); track option.value) {
          <option [value]="option.value">{{ option.label }}</option>
        }
      </select>
    </div>

    <div class="button-group">
      <button class="btn-transfer" (click)="processWithTransfer()" [disabled]="isLoading()">
        {{ texts().demo.transferButton }}<br>
        <small style="font-size: 11px; font-weight: normal;">{{ texts().demo.transferNote }}</small>
      </button>
      <button class="btn-clone" (click)="processWithClone()" [disabled]="isLoading()">
        {{ texts().demo.cloneButton }}<br>
        <small style="font-size: 11px; font-weight: normal;">{{ texts().demo.cloneNote }}</small>
      </button>
    </div>

    <div class="spinner" [class.active]="isLoading()"></div>
    
    <div class="canvas-container" #canvasContainer></div>
  </div>

  <div class="comparison" [style.display]="(transferTime() > 0 && cloneTime() > 0) ? 'grid' : 'none'">
    <div class="comparison-item transfer">
      <div class="label">{{ texts().comparison.transferLabel }}</div>
      <div class="value">{{ transferTime() }}</div>
      <div class="unit">{{ texts().comparison.unit }}</div>
    </div>
    <div class="comparison-item clone">
      <div class="label">{{ texts().comparison.cloneLabel }}</div>
      <div class="value">{{ cloneTime() }}</div>
      <div class="unit">{{ texts().comparison.unit }}</div>
    </div>
  </div>

  @if (transferTime() > 0 && cloneTime() > 0) {
    <div class="result">
      <strong>{{ texts().result.title }}</strong>
      <p>
        <strong>{{ texts().result.improvementLabel }}</strong> {{ ((cloneTime() - transferTime()) / cloneTime() * 100).toFixed(1) }}{{ texts().result.improvementSuffix }}<br>
        <strong>{{ texts().result.differenceLabel }}</strong> {{ cloneTime() - transferTime() }} {{ texts().result.differenceSuffix }}
      </p>
    </div>
  }
</div>
